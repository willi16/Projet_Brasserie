{% extends "base.html" %}
{% load static %}

{% block title %}Rapport des ventes{% endblock %}

{% block content %}
  <h2>Rapport des ventes</h2>

  <!-- Filtres -->
  <form method="get" class="row mb-4">
    <div class="col-md-2">
      <label>Date d√©but</label>
      <input type="date" name="date_debut" class="form-control" value="{{ date_debut|date:'Y-m-d' }}">
    </div>
    <div class="col-md-2">
      <label>Date fin</label>
      <input type="date" name="date_fin" class="form-control" value="{{ date_fin|date:'Y-m-d' }}">
    </div>
    <div class="col-md-2">
      <label>P√©riode</label>
      <select name="periode" class="form-select">
        <option value="">Toutes les p√©riodes</option>
        <option value="journalier" {% if periode == 'journalier' %}selected{% endif %}>Journalier</option>
        <option value="hebdomadaire" {% if periode == 'hebdomadaire' %}selected{% endif %}>Hebdomadaire</option>
        <option value="mensuel" {% if periode == 'mensuel' %}selected{% endif %}>Mensuel</option>
      </select>
    </div>
    <div class="col-md-2">
      <button type="submit" class="btn btn-primary mt-4">Filtrer</button>
      <a href="{% url 'gestion_depot:rapport_ventes' %}" class="btn btn-secondary mt-4">R√©initialiser</a>
    </div>
    <div class="col-md-2 mt-4">
      <a href="?export=excel&date_debut={{ date_debut|date:'Y-m-d' }}&date_fin={{ date_fin|date:'Y-m-d' }}&periode={{ periode }}"
         class="btn btn-success">üì• Exporter Excel</a>
    </div>
  </form>

  <!-- R√©sum√© -->
  <div class="alert alert-info">
    <strong>Total des ventes :</strong> {{ total_revenu|floatformat:0 }} FCFA
  </div>

  <!-- Statistiques -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-success text-white">
          <h5>‚úÖ Produit le plus vendu</h5>
        </div>
        <div class="card-body">
          {% if produit_plus_vendu %}
            <p><strong>{{ produit_plus_vendu.produit__nom }}</strong></p>
            <p>Quantit√© totale : {{ produit_plus_vendu.quantite_totale|floatformat:2 }} casiers</p>
            <p>Revenu total : {{ produit_plus_vendu.revenu_total|floatformat:0 }} FCFA</p>
          {% else %}
            <p>Aucune vente trouv√©e.</p>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-danger text-white">
          <h5>‚ö†Ô∏è Produit le moins vendu</h5>
        </div>
        <div class="card-body">
          {% if produit_moins_vendu %}
            <p><strong>{{ produit_moins_vendu.produit__nom }}</strong></p>
            <p>Quantit√© totale : {{ produit_moins_vendu.quantite_totale|floatformat:2 }} casiers</p>
            <p>Revenu total : {{ produit_moins_vendu.revenu_total|floatformat:0 }} FCFA</p>
          {% else %}
            <p>Aucune vente trouv√©e.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Inventaire -->
  <div class="card mb-4">
    <div class="card-header bg-light">
      <h5>üì¶ Inventaire</h5>
    </div>
    <div class="card-body">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Produit</th>
            <th>Stock</th>
            <th>Seuil d'alerte</th>
            <th>Statut</th>
          </tr>
        </thead>
        <tbody>
          {% for item in inventaire %}
            <tr>
              <td>{{ item.nom }}</td>
              <td>{{ item.stock }}</td>
              <td>{{ item.seuil_alerte }}</td>
              <td>
                <span class="badge {% if item.en_alerte %}bg-warning text-dark{% else %}bg-success{% endif %}">
                  {% if item.en_alerte %}‚ö†Ô∏è Stock bas{% else %}‚úÖ OK{% endif %}
                </span>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="4" class="text-center">Aucun produit trouv√©.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Graphique des ventes -->
  <div class="card mb-4">
    <div class="card-header bg-light">
      <h5>üìà √âvolution des ventes</h5>
    </div>
    <div class="card-body">
      <canvas id="ventesChart" width="400" height="200"></canvas>
    </div>
  </div>

  <!-- ‚úÖ Chart.js en local (pas de CDN) -->
  <script src="{% static 'js/chart.umd.min.js' %}"></script>
  <script>
    const ctx = document.getElementById('ventesChart').getContext('2d');
    const labels = JSON.parse('{{ labels_jours|safe }}');
    const data = JSON.parse('{{ data_ventes|safe }}');

    new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Ventes (FCFA)',
          data: data,
          borderColor: 'rgba(75, 192, 192, 1)',
          backgroundColor: 'rgba(75, 192, 192, 0.2)',
          borderWidth: 2,
          fill: true
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'top',
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return value.toLocaleString() + ' FCFA';
              }
            }
          }
        }
      }
    });
  </script>

{% endblock %}