{% extends "base.html" %}

{% block title %}Enregistrer une livraison{% endblock %}

{% block content %}
  <h2>Enregistrer une livraison</h2>

  <form method="post">
    {% csrf_token %}
    <div class="mb-3">
      <label for="fournisseur" class="form-label">Fournisseur</label>
      <select class="form-select" id="fournisseur" name="fournisseur" required>
        {% for fournisseur in fournisseurs %}
          <option value="{{ fournisseur.id }}">{{ fournisseur.nom }}</option>
        {% endfor %}
      </select>
    </div>

    <h4>Lignes de livraison</h4>
    <div id="lignes-container">
      <div class="ligne mb-3">
        <div class="row">
          <div class="col-md-5">
            <label>Produit</label>
            <select name="produit" class="form-select" required>
              {% for produit in produits %}
                <option value="{{ produit.id }}">{{ produit.nom }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label>Quantit√© (casiers)</label>
            <input type="number" name="quantite" class="form-control" min="0.01" step="0.01" required>
          </div>
          <div class="col-md-3">
            <button type="button" class="btn btn-danger remove-ligne">Supprimer</button>
          </div>
        </div>
      </div>
    </div>

    <button type="button" id="add-ligne" class="btn btn-secondary mb-3">Ajouter une ligne</button>
    <button type="submit" class="btn btn-primary">Enregistrer la livraison</button>
    <a href="{% url 'gestion_depot:liste_livraisons' %}" class="btn btn-secondary">Annuler</a>
  </form>

  <script>
    document.getElementById('add-ligne').addEventListener('click', function () {
      const container = document.getElementById('lignes-container');
      const newLigne = container.querySelector('.ligne').cloneNode(true);
      newLigne.querySelector('select[name="produit"]').value = '';
      newLigne.querySelector('input[name="quantite"]').value = '';
      container.appendChild(newLigne);

      newLigne.querySelector('.remove-ligne').addEventListener('click', function () {
        newLigne.remove();
      });
    });

    document.querySelectorAll('.remove-ligne').forEach(btn => {
      btn.addEventListener('click', function () {
        this.closest('.ligne').remove();
      });
    });
  </script>
{% endblock %}